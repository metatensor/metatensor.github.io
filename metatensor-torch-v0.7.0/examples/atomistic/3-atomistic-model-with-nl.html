<!doctype html>
<html class="no-js" lang="en" data-content_root="../../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" /><link rel="next" title="Profiling your models" href="4-profiling.html" /><link rel="prev" title="Running Molecular Dynamics with ASE" href="2-running-ase-md.html" />

    <link rel="shortcut icon" href="../../_static/metatensor-64.png"/><!-- Generated with Sphinx 7.4.7 and Furo 2024.08.06 -->
        <title>Creating models that use neighbor lists - Metatensor</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/metatensor.css?v=4d63172e" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css?v=d2d258e8" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-binder.css?v=f4aeca0c" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-dataframe.css?v=2082cf3c" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=302659d7" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">Metatensor</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo only-light" src="../../_static/images/metatensor-horizontal.png" alt="Light Logo"/>
    <img class="sidebar-logo only-dark" src="../../_static/images/metatensor-horizontal-dark.png" alt="Dark Logo"/>
  </div>
  
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../goals.html">Metatensor’s goals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../core/index.html">Core classes</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Core classes</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../core/overview.html">Overview</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../core/reference/python/index.html">Python API reference</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Python API reference</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../core/reference/python/tensor.html">TensorMap</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../core/reference/python/block.html">TensorBlock</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../core/reference/python/labels.html">Labels</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../core/reference/python/io.html">Serialization</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../core/reference/python/data.html">Data arrays</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../core/reference/python/misc.html">Miscellaneous</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../core/reference/cxx/index.html">C++ API reference</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of C++ API reference</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../core/reference/cxx/tensor.html">TensorMap</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../core/reference/cxx/labels.html">Labels</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../core/reference/cxx/block.html">TensorBlock</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../core/reference/cxx/data.html">Data arrays</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../core/reference/cxx/misc.html">Miscellaneous</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../core/reference/c/index.html">C API reference</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of C API reference</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../core/reference/c/tensor.html">TensorMap</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../core/reference/c/labels.html">Labels</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../core/reference/c/block.html">TensorBlock</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../core/reference/c/data.html">Data arrays</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../core/reference/c/misc.html">Miscellaneous</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../core/reference/rust/index.html">Rust API reference</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../core/index.html">Tutorials</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle navigation of Tutorials</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../core/1-first-steps.html">First steps with metatensor</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/2-handling-sparsity.html">Handling sparsity</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/3-managing-gradients.html">Managing gradients</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../core/CHANGELOG.html">Changelog</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../operations/index.html">Operations</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle navigation of Operations</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../operations/torch.html">Operations and PyTorch</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../operations/reference/index.html">API reference</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><div class="visually-hidden">Toggle navigation of API reference</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../operations/reference/creation/index.html">Creation operations</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" role="switch" type="checkbox"/><label for="toctree-checkbox-8"><div class="visually-hidden">Toggle navigation of Creation operations</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/creation/empty_like.html">empty_like()</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/creation/ones_like.html">ones_like()</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/creation/zeros_like.html">zeros_like()</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/creation/random_like.html">random_like()</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/creation/block_from_array.html">block_from_array()</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../operations/reference/linear_algebra/index.html">Linear algebra</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" role="switch" type="checkbox"/><label for="toctree-checkbox-9"><div class="visually-hidden">Toggle navigation of Linear algebra</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/linear_algebra/dot.html">dot()</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/linear_algebra/lstsq.html">lstsq()</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/linear_algebra/solve.html">solve()</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../operations/reference/logic/index.html">Logic function</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" role="switch" type="checkbox"/><label for="toctree-checkbox-10"><div class="visually-hidden">Toggle navigation of Logic function</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/logic/allclose.html">allclose()</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/logic/equal.html">equal()</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/logic/equal-metadata.html">equal_metadata()</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/logic/is-contiguous.html">is_contiguous()</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../operations/reference/manipulation/index.html">Manipulation operations</a><input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" role="switch" type="checkbox"/><label for="toctree-checkbox-11"><div class="visually-hidden">Toggle navigation of Manipulation operations</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/manipulation/detach.html">detach()</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/manipulation/drop-blocks.html">drop_blocks()</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/manipulation/filter-blocks.html">filter_blocks()</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/manipulation/join.html">join()</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/manipulation/make-contiguous.html">make_contiguous()</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/manipulation/manipulate-dimension.html">manipulate dimension</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/manipulation/one-hot.html">one_hot()</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/manipulation/remove-gradients.html">remove_gradients()</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/manipulation/requires-grad.html">requires_grad()</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/manipulation/samples-reduction.html">samples reduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/manipulation/slice.html">slice()</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/manipulation/split.html">split()</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../operations/reference/math/index.html">Mathematical functions</a><input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" role="switch" type="checkbox"/><label for="toctree-checkbox-12"><div class="visually-hidden">Toggle navigation of Mathematical functions</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/math/abs.html">abs()</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/math/add.html">add()</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/math/divide.html">divide()</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/math/multiply.html">multiply()</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/math/pow.html">pow()</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/math/subtract.html">subtract()</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../operations/reference/set/index.html">Set operations</a><input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" role="switch" type="checkbox"/><label for="toctree-checkbox-13"><div class="visually-hidden">Toggle navigation of Set operations</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/set/unique_metadata.html">unique_metadata()</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/set/sort.html">sort()</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/reference/checks.html">Checks</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../operations/CHANGELOG.html">Changelog</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../torch/index.html">TorchScript backend</a><input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" role="switch" type="checkbox"/><label for="toctree-checkbox-14"><div class="visually-hidden">Toggle navigation of TorchScript backend</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../torch/reference/index.html">API reference</a><input class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" role="switch" type="checkbox"/><label for="toctree-checkbox-15"><div class="visually-hidden">Toggle navigation of API reference</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../torch/reference/tensor.html">TensorMap</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../torch/reference/block.html">TensorBlock</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../torch/reference/labels.html">Labels</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../torch/reference/serialization.html">Serialization</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../torch/reference/cxx/index.html">TorchScript C++ API reference</a><input class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" role="switch" type="checkbox"/><label for="toctree-checkbox-16"><div class="visually-hidden">Toggle navigation of TorchScript C++ API reference</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../torch/reference/cxx/tensor.html">TensorMap</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../torch/reference/cxx/block.html">TensorBlock</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../torch/reference/cxx/labels.html">Labels</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../torch/reference/cxx/miscellaneous.html">Miscellaneous</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../torch/CHANGELOG.html">Changelog</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../learn/index.html">Learning utilities</a><input class="toctree-checkbox" id="toctree-checkbox-17" name="toctree-checkbox-17" role="switch" type="checkbox"/><label for="toctree-checkbox-17"><div class="visually-hidden">Toggle navigation of Learning utilities</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../learn/reference/index.html">API reference</a><input class="toctree-checkbox" id="toctree-checkbox-18" name="toctree-checkbox-18" role="switch" type="checkbox"/><label for="toctree-checkbox-18"><div class="visually-hidden">Toggle navigation of API reference</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../learn/reference/data/index.html">Data utilites</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../learn/reference/nn/index.html">Neural Network</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../learn/index.html">Tutorials</a><input class="toctree-checkbox" id="toctree-checkbox-19" name="toctree-checkbox-19" role="switch" type="checkbox"/><label for="toctree-checkbox-19"><div class="visually-hidden">Toggle navigation of Tutorials</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../learn/1-dataset-dataloader.html">Datasets and data loaders</a></li>
<li class="toctree-l3"><a class="reference internal" href="../learn/2-indexed-dataset.html">Using IndexedDataset</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../learn/CHANGELOG.html">Changelog</a></li>
</ul>
</li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="../../atomistic/index.html">Atomistic applications</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-20" name="toctree-checkbox-20" role="switch" type="checkbox"/><label for="toctree-checkbox-20"><div class="visually-hidden">Toggle navigation of Atomistic applications</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../atomistic/overview.html">Overview</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../atomistic/reference/index.html">API reference</a><input class="toctree-checkbox" id="toctree-checkbox-21" name="toctree-checkbox-21" role="switch" type="checkbox"/><label for="toctree-checkbox-21"><div class="visually-hidden">Toggle navigation of API reference</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../atomistic/reference/systems.html">Systems</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../atomistic/reference/models/index.html">Models</a><input class="toctree-checkbox" id="toctree-checkbox-22" name="toctree-checkbox-22" role="switch" type="checkbox"/><label for="toctree-checkbox-22"><div class="visually-hidden">Toggle navigation of Models</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../atomistic/reference/models/export.html">Exporting models</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../atomistic/reference/models/metadata.html">Information about models</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../atomistic/reference/ase.html">Atomic Simulation Environment (ASE) integration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../atomistic/reference/serialization.html">Serialization</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../atomistic/reference/cxx/index.html">C++ API reference</a><input class="toctree-checkbox" id="toctree-checkbox-23" name="toctree-checkbox-23" role="switch" type="checkbox"/><label for="toctree-checkbox-23"><div class="visually-hidden">Toggle navigation of C++ API reference</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../atomistic/reference/cxx/systems.html">Systems</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../atomistic/reference/cxx/models.html">Models</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../atomistic/outputs/index.html">Standard model outputs</a><input class="toctree-checkbox" id="toctree-checkbox-24" name="toctree-checkbox-24" role="switch" type="checkbox"/><label for="toctree-checkbox-24"><div class="visually-hidden">Toggle navigation of Standard model outputs</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../atomistic/outputs/energy.html">Energy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../atomistic/outputs/features.html">Features</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../atomistic/engines/index.html">Simulation engines</a><input class="toctree-checkbox" id="toctree-checkbox-25" name="toctree-checkbox-25" role="switch" type="checkbox"/><label for="toctree-checkbox-25"><div class="visually-hidden">Toggle navigation of Simulation engines</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../atomistic/engines/ase.html">ASE</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../atomistic/engines/chemiscope.html">Chemiscope</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../atomistic/engines/ipi.html">i-PI</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../atomistic/engines/lammps.html">LAMMPS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../atomistic/engines/plumed.html">PLUMED</a></li>
</ul>
</li>
<li class="toctree-l2 current has-children"><a class="reference internal" href="index.html">Tutorials</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-26" name="toctree-checkbox-26" role="switch" type="checkbox"/><label for="toctree-checkbox-26"><div class="visually-hidden">Toggle navigation of Tutorials</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="1-export-atomistic-model.html">Exporting a model</a></li>
<li class="toctree-l3"><a class="reference internal" href="2-running-ase-md.html">Running Molecular Dynamics with ASE</a></li>
<li class="toctree-l3 current current-page"><a class="current reference internal" href="#">Creating models that use neighbor lists</a></li>
<li class="toctree-l3"><a class="reference internal" href="4-profiling.html">Profiling your models</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../devdoc/index.html">Developer documentation</a><input class="toctree-checkbox" id="toctree-checkbox-27" name="toctree-checkbox-27" role="switch" type="checkbox"/><label for="toctree-checkbox-27"><div class="visually-hidden">Toggle navigation of Developer documentation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../devdoc/get-started.html">Getting started</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../devdoc/architecture.html">Code organization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../devdoc/versions.html">Version number management</a></li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="../../_sources/examples/atomistic/3-atomistic-model-with-nl.rst.txt" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div>
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference internal" href="#sphx-glr-download-examples-atomistic-3-atomistic-model-with-nl-py"><span class="std std-ref">Go to the end</span></a>
to download the full example code.</p>
</div>
<section class="sphx-glr-example-title" id="creating-models-that-use-neighbor-lists">
<span id="atomistic-tutorial-nl-md"></span><span id="sphx-glr-examples-atomistic-3-atomistic-model-with-nl-py"></span><h1>Creating models that use neighbor lists<a class="headerlink" href="#creating-models-that-use-neighbor-lists" title="Link to this heading">¶</a></h1>
<p>This tutorial demonstrates how to create an atomistic model that requires a neighbor
list, and use it to run MD simulations. This tutorial assumes knowledge of how to export
an atomistic model and run it with the ASE calculator. If you haven’t read the
corresponding examples, please refer to <a class="reference internal" href="1-export-atomistic-model.html#atomistic-tutorial-export"><span class="std std-ref">Exporting a model</span></a> and
<a class="reference internal" href="2-running-ase-md.html#atomistic-tutorial-md"><span class="std std-ref">Running Molecular Dynamics with ASE</span></a>.</p>
<p>As depicted below, one or more neighbor lists will be requested by the model, computed
by the simulation engine and attached to the <code class="xref py py-class docutils literal notranslate"><span class="pre">Systems</span></code>. The
<code class="xref py py-class docutils literal notranslate"><span class="pre">Systems</span></code> with the neighbor list is then passed to the model.</p>
<figure class="align-center" id="id1">
<a class="reference internal image-reference" href="../../_images/nl-dataflow.svg"><img alt="../../_images/nl-dataflow.svg" src="../../_images/nl-dataflow.svg" style="width: 600px;" />
</a>
<figcaption>
<p><span class="caption-text">The simulation engine computes the neighbor lists for the model, which then uses
them to predict outputs. This figure is a subset of the figure in
<a class="reference internal" href="../../atomistic/overview.html#model-dataflow"><span class="std std-ref">Data flow between the model and engine</span></a>.</span><a class="headerlink" href="#id1" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<p>As example, we will run a 1 ps short molecular dynamics simulation of 125 already
equilibrated liquid argon atoms interacting via Lennard-Jones within a cutoff of 5 Å.
The system will be simulated at a temperature of 94.4 K and a mass density of
1.374 g/cm³. In the end, we will obtain the pair-correlation function <span class="math notranslate nohighlight">\(g(r)\)</span> of
the liquid.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>

<span class="c1"># tools for analysis</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ase.geometry.rdf</span>

<span class="c1"># tools to run the simulation and visualization</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ase.io</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ase.md</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ase.neighborlist</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ase.visualize.plot</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">chemiscope</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="c1"># the usual suspects</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">metatensor.torch</span><span class="w"> </span><span class="kn">import</span> <span class="n">Labels</span><span class="p">,</span> <span class="n">TensorBlock</span><span class="p">,</span> <span class="n">TensorMap</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">metatensor.torch.atomistic</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">MetatensorAtomisticModel</span><span class="p">,</span>
    <span class="n">ModelCapabilities</span><span class="p">,</span>
    <span class="n">ModelMetadata</span><span class="p">,</span>
    <span class="n">ModelOutput</span><span class="p">,</span>
    <span class="n">NeighborListOptions</span><span class="p">,</span>
    <span class="n">System</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Integration with ASE calculator for metatensor atomistic models</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">metatensor.torch.atomistic.ase_calculator</span><span class="w"> </span><span class="kn">import</span> <span class="n">MetatensorCalculator</span>
</pre></div>
</div>
<section id="the-simulation-system">
<h2>The simulation system<a class="headerlink" href="#the-simulation-system" title="Link to this heading">¶</a></h2>
<p>We load the pre-equilibrated <a class="reference download internal" download="" href="../../_downloads/3eaf30bdd5ec66c85afeb1deff7e84ec/liquid-argon.xyz"><code class="xref download docutils literal notranslate"><span class="pre">liquid</span> <span class="pre">argon</span> <span class="pre">system</span> <span class="pre">from</span> <span class="pre">a</span>
<span class="pre">file</span></code></a>.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">atoms</span> <span class="o">=</span> <span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;liquid-argon.xyz&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The system was generated based on a 5x5x5 supercell of a simple cubic (sc) cell with a
lattice constant of a = 3.641 Å. After initialization of the velocities, the system
was run for 100 ps with the same parameters we will use below and the final state can
be visualized as</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">ax</span> <span class="o">=</span> <span class="n">ase</span><span class="o">.</span><span class="n">visualize</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">plot_atoms</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">radii</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;$</span><span class="se">\\</span><span class="s2">AA$&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$</span><span class="se">\\</span><span class="s2">AA$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_3-atomistic-model-with-nl_001.png" srcset="../../_images/sphx_glr_3-atomistic-model-with-nl_001.png" alt="3 atomistic model with nl" class = "sphx-glr-single-img"/><p>The system already has velocities and the expected density of 1.374 g/cm³.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">u_to_g</span> <span class="o">=</span> <span class="mf">1.66053906660e-24</span>
<span class="n">Å_to_cm</span> <span class="o">=</span> <span class="mf">1e-08</span>

<span class="n">mass_density</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">atoms</span><span class="o">.</span><span class="n">get_masses</span><span class="p">())</span> <span class="o">/</span> <span class="n">atoms</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">volume</span> <span class="o">*</span> <span class="n">u_to_g</span> <span class="o">/</span> <span class="n">Å_to_cm</span><span class="o">**</span><span class="mi">3</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ρ_m = </span><span class="si">{</span><span class="n">mass_density</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> g/cm³&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>ρ_m = 1.374 g/cm³
</pre></div>
</div>
</section>
<section id="metatensor-s-neighbor-lists">
<h2>Metatensor’s neighbor lists<a class="headerlink" href="#metatensor-s-neighbor-lists" title="Link to this heading">¶</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The steps below of creating a neighbor list, wrapping it inside a
<a class="reference internal" href="../../torch/reference/block.html#metatensor.torch.TensorBlock" title="metatensor.torch.TensorBlock"><code class="xref py py-class docutils literal notranslate"><span class="pre">TensorBlock</span></code></a> and attaching it to a system
will be done by the simulation engine and must not be handled by the model
developer. How to request a neighbor list will be presented below when the actual
model is defined.</p>
</div>
<p>Before implementing the actual model, let’s take a look at how metatensor stores
neighbor lists inside a <a class="reference internal" href="../../atomistic/reference/systems.html#metatensor.torch.atomistic.System" title="metatensor.torch.atomistic.System"><code class="xref py py-class docutils literal notranslate"><span class="pre">System</span></code></a> object. We start by computing the neighbor
list for our argon systen using ASE.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="n">ase</span><span class="o">.</span><span class="n">neighborlist</span><span class="o">.</span><span class="n">neighbor_list</span><span class="p">(</span><span class="n">quantities</span><span class="o">=</span><span class="s2">&quot;ijSD&quot;</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">atoms</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span>
</pre></div>
</div>
<p>The <a class="reference external" href="https://wiki.fysik.dtu.dk/ase/ase/neighborlist.html#ase.neighborlist.neighbor_list" title="(in ASE)"><code class="xref py py-func docutils literal notranslate"><span class="pre">ase.neighborlist.neighbor_list()</span></code></a> function returns the neighbor indices:
quantities <code class="docutils literal notranslate"><span class="pre">&quot;i&quot;</span></code> and <code class="docutils literal notranslate"><span class="pre">&quot;j&quot;</span></code>, the neighbor shifts <code class="docutils literal notranslate"><span class="pre">&quot;S&quot;</span></code>, and the distance
vectors <code class="docutils literal notranslate"><span class="pre">&quot;D&quot;</span></code>. We now stack these together and convert them into the suitable
types.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">i</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
<span class="n">j</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
<span class="n">neighbor_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">neighbor_shifts</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;neighbor_indices:&quot;</span><span class="p">,</span> <span class="n">neighbor_indices</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;neighbor_shifts:&quot;</span><span class="p">,</span> <span class="n">neighbor_shifts</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>neighbor_indices: tensor([[  0,  20],
        [  0,   4],
        [  0,   5],
        ...,
        [124, 123],
        [124, 119],
        [124,  94]])
neighbor_shifts: tensor([[ 1, -1, -1],
        [ 0,  0, -1],
        [ 1,  0, -1],
        ...,
        [ 0,  0,  0],
        [ 0,  0,  0],
        [ 0,  0,  0]])
</pre></div>
</div>
<section id="creating-a-neighbor-list">
<h3>Creating a neighbor list<a class="headerlink" href="#creating-a-neighbor-list" title="Link to this heading">¶</a></h3>
<p>We now assemble the neighbor list following metatensor conventions. First, we create
the <code class="docutils literal notranslate"><span class="pre">samples</span></code> metadata for the <a class="reference internal" href="../../torch/reference/block.html#metatensor.torch.TensorBlock" title="metatensor.torch.TensorBlock"><code class="xref py py-class docutils literal notranslate"><span class="pre">TensorBlock</span></code></a> which will hold the neighbor list.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">sample_values</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">neighbor_indices</span><span class="p">,</span> <span class="n">neighbor_shifts</span><span class="p">])</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">Labels</span><span class="p">(</span>
    <span class="n">names</span><span class="o">=</span><span class="p">[</span>
        <span class="s2">&quot;first_atom&quot;</span><span class="p">,</span>
        <span class="s2">&quot;second_atom&quot;</span><span class="p">,</span>
        <span class="s2">&quot;cell_shift_a&quot;</span><span class="p">,</span>
        <span class="s2">&quot;cell_shift_b&quot;</span><span class="p">,</span>
        <span class="s2">&quot;cell_shift_c&quot;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="n">values</span><span class="o">=</span><span class="n">sample_values</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">neighbors</span> <span class="o">=</span> <span class="n">TensorBlock</span><span class="p">(</span>
    <span class="n">values</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">D</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="n">samples</span><span class="o">=</span><span class="n">samples</span><span class="p">,</span>
    <span class="n">components</span><span class="o">=</span><span class="p">[</span><span class="n">Labels</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="s2">&quot;xyz&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)],</span>
    <span class="n">properties</span><span class="o">=</span><span class="n">Labels</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="s2">&quot;distance&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">neighbors</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>TensorBlock
    samples (1356): [&#39;first_atom&#39;, &#39;second_atom&#39;, &#39;cell_shift_a&#39;, &#39;cell_shift_b&#39;, &#39;cell_shift_c&#39;]
    components (3): [&#39;xyz&#39;]
    properties (1): [&#39;distance&#39;]
    gradients: None
</pre></div>
</div>
<p>The data and metadata inside the <code class="docutils literal notranslate"><span class="pre">neighbors</span></code> object do not contain information about
the <code class="docutils literal notranslate"><span class="pre">cutoff</span></code>, whether this is a full or half neighbor list, and whether it is
restricted to distances strictly below the cutoff. To account for this, metatensor
neighbor lists are always stored together with <a class="reference internal" href="../../atomistic/reference/systems.html#metatensor.torch.atomistic.NeighborListOptions" title="metatensor.torch.atomistic.NeighborListOptions"><code class="xref py py-class docutils literal notranslate"><span class="pre">NeighborListOptions</span></code></a>. For
example, these options can be defined with</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">options</span> <span class="o">=</span> <span class="n">NeighborListOptions</span><span class="p">(</span><span class="n">cutoff</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">full_list</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">full_list=True</span></code> will give us a list where each <cite>i, j</cite> pair appears twice, stored
once as <cite>i, j</cite> and once as <cite>j, i</cite>. <code class="docutils literal notranslate"><span class="pre">full_list=False</span></code> would give us a half list, with
each pair only stored once. Depending on your model, either of these can be more
convenient or faster.</p>
<p><code class="docutils literal notranslate"><span class="pre">strict=True</span></code> will give us a list where all pairs are strictly contained inside the
cutoff radius. This is always safe to do and should be your default option.
<code class="docutils literal notranslate"><span class="pre">strict=False</span></code> can contain additional pairs that you would need to handle
explicitly, either by adding a cutoff smoothing function to make the contribution of
pairs outside the cutoff got to zero; or by filtering out such pairs. The advantage of
using <code class="docutils literal notranslate"><span class="pre">strict=False</span></code> is that this will allow simulation engines to re-use the same
neighbor list across multiple simulation steps, making the overall simulation faster.
It is however a tradeoff, since with <code class="docutils literal notranslate"><span class="pre">strict=False</span></code> the model itself will have to
process more pairs.</p>
<p>With this we can, in principle, attach the neighbor list to a metatensor system using</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">system</span><span class="o">.</span><span class="n">add_neighbor_list</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> <span class="n">neighbors</span><span class="o">=</span><span class="n">neighbors</span><span class="p">)</span>
</pre></div>
</div>
<p>To reiterate, in a typical simulation setup computing the neighbor list and attaching
it to the system is done by the simulation engine, and model authors do not have to
worry about it.</p>
<p>The model can then retrieve the neighbor list with</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">system</span><span class="o">.</span><span class="n">get_neighbor_list</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="accessing-data-in-neighbor-lists">
<h3>Accessing data in neighbor lists<a class="headerlink" href="#accessing-data-in-neighbor-lists" title="Link to this heading">¶</a></h3>
<p>Now that we have a neighbor list, we can access the data and metadata. First, we can
extract the <code class="docutils literal notranslate"><span class="pre">distances</span></code> vectors between the neighboring pairs within the cutoff,
which we can then use in our models.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">distances</span> <span class="o">=</span> <span class="n">neighbors</span><span class="o">.</span><span class="n">values</span>

<span class="nb">print</span><span class="p">(</span><span class="n">distances</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>torch.Size([1356, 3, 1])
</pre></div>
</div>
<p>We can also get the metadata values like <em>neighbor indices</em> or the <em>neighbor
shifts</em> using the <a class="reference internal" href="../../torch/reference/labels.html#metatensor.torch.Labels.column" title="metatensor.torch.Labels.column"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Labels.column</span></code></a> and
<a class="reference internal" href="../../torch/reference/labels.html#metatensor.torch.Labels.view" title="metatensor.torch.Labels.view"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Labels.view</span></code></a> methods.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">i</span> <span class="o">=</span> <span class="n">neighbors</span><span class="o">.</span><span class="n">samples</span><span class="o">.</span><span class="n">column</span><span class="p">(</span><span class="s2">&quot;first_atom&quot;</span><span class="p">)</span>
<span class="n">j</span> <span class="o">=</span> <span class="n">neighbors</span><span class="o">.</span><span class="n">samples</span><span class="o">.</span><span class="n">column</span><span class="p">(</span><span class="s2">&quot;second_atom&quot;</span><span class="p">)</span>

<span class="n">neighbor_indices</span> <span class="o">=</span> <span class="n">neighbors</span><span class="o">.</span><span class="n">samples</span><span class="o">.</span><span class="n">view</span><span class="p">([</span><span class="s2">&quot;first_atom&quot;</span><span class="p">,</span> <span class="s2">&quot;second_atom&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">values</span>
<span class="n">neighbor_shifts</span> <span class="o">=</span> <span class="n">neighbors</span><span class="o">.</span><span class="n">samples</span><span class="o">.</span><span class="n">view</span><span class="p">(</span>
    <span class="p">[</span><span class="s2">&quot;cell_shift_a&quot;</span><span class="p">,</span> <span class="s2">&quot;cell_shift_b&quot;</span><span class="p">,</span> <span class="s2">&quot;cell_shift_c&quot;</span><span class="p">]</span>
<span class="p">)</span><span class="o">.</span><span class="n">values</span>
</pre></div>
</div>
<p>As mentioned above, in practical use cases you will not have to compute neighbor lists
yourself, but instead the simulation engine will compute it for you and you’ll just
need to get the right list for a given <a class="reference internal" href="../../atomistic/reference/systems.html#metatensor.torch.atomistic.System" title="metatensor.torch.atomistic.System"><code class="xref py py-class docutils literal notranslate"><span class="pre">System</span></code></a> using the corresponding
<code class="docutils literal notranslate"><span class="pre">options</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">neighbors</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">get_neighbor_list</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
</pre></div>
</div>
<p>You can also loop over all attached lists of a <a class="reference internal" href="../../atomistic/reference/systems.html#metatensor.torch.atomistic.System" title="metatensor.torch.atomistic.System"><code class="xref py py-class docutils literal notranslate"><span class="pre">System</span></code></a> using
<a class="reference internal" href="../../atomistic/reference/systems.html#metatensor.torch.atomistic.System.known_neighbor_lists" title="metatensor.torch.atomistic.System.known_neighbor_lists"><code class="xref py py-meth docutils literal notranslate"><span class="pre">System.known_neighbor_lists()</span></code></a> to find a suitable one based on
<a class="reference internal" href="../../atomistic/reference/systems.html#metatensor.torch.atomistic.NeighborListOptions" title="metatensor.torch.atomistic.NeighborListOptions"><code class="xref py py-class docutils literal notranslate"><span class="pre">NeighborListOptions</span></code></a> attributes like <code class="docutils literal notranslate"><span class="pre">cutoff</span></code>, <code class="docutils literal notranslate"><span class="pre">full_list</span></code>, and
<code class="docutils literal notranslate"><span class="pre">requestors</span></code>.</p>
</section>
</section>
<section id="a-lennard-jones-model">
<h2>A Lennard-Jones model<a class="headerlink" href="#a-lennard-jones-model" title="Link to this heading">¶</a></h2>
<p>Now that we know how the neighbor data is stored and can be accessed, and know how to
use it we can construct our Lennard-Jones model with a fixed cutoff. The Lennard-Jones
potential is a mathematical basis to approximate the interaction between a pair of
neutral atoms or molecules. It is given by the equation:</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[V(r) = 4\epsilon \left[ \left( \frac{\sigma}{r} \right)^{12} - \left(
\frac{\sigma}{r} \right)^{6} \right]\]</div>
</div>
<p>where <span class="math notranslate nohighlight">\(\epsilon\)</span> is the depth of the potential well, <span class="math notranslate nohighlight">\(\sigma\)</span> is the
finite distance at which the inter-particle potential is zero, and <span class="math notranslate nohighlight">\(r\)</span> is the
distance between the particles. The 12-6 form is chosen because the <span class="math notranslate nohighlight">\(r^{12}\)</span>
term approximates the Pauli repulsion at short ranges, while the <span class="math notranslate nohighlight">\(r^6\)</span> term
represents the attractive van der Waals forces. The <span class="math notranslate nohighlight">\(r^{12}\)</span> is chosen because
it is just the <em>square</em> of the <span class="math notranslate nohighlight">\(r^6\)</span> and therefore allows fast evaluation.</p>
<p>A Lennard-Jones potential is well-suited for argon because it accurately represents
the van der Waals forces that dominate the interactions between argon atoms, as for
all noble gases. This potential was used in one of the first MD simulations:
“Correlation in the motions of atoms in liquid Argon” by A. Rahman (<a class="reference external" href="https://link.aps.org/doi/10.1103/PhysRev.136.A405">Phys. Rev. 136,
A405-A411, 1964</a>), which
demonstrated the effectiveness of continuous potentials in molecular dynamics.</p>
<p>The model below is a simplified version of a <a class="reference external" href="https://github.com/Luthaf/metatensor-lj-test/blob/main/src/metatensor_lj_test/pure.py">more complex Lennard-Jones model</a>.
The linked version also implements <code class="docutils literal notranslate"><span class="pre">per_atom</span></code> energies as well as atom selection
using the <code class="docutils literal notranslate"><span class="pre">selected_atoms</span></code> parameter of the <code class="docutils literal notranslate"><span class="pre">forward()</span></code> method. In this model, we
shift the energy by its value at the <code class="docutils literal notranslate"><span class="pre">cutoff</span></code>. This will break the conservativeness
of the potential, which is unproblematic in here because we use a large cutoff and
therefore the potential already almost decayed to zero. For more sophisticated methods
like a polynomial switching potential like XPLOR, we refer to the literature.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">LennardJonesModel</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Implementation of a single particle type Lennard-Jones potential.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># define neighbor list options to request the right set of neighbors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nl_options</span> <span class="o">=</span> <span class="n">NeighborListOptions</span><span class="p">(</span>
            <span class="n">cutoff</span><span class="o">=</span><span class="n">cutoff</span><span class="p">,</span> <span class="n">full_list</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sigma</span> <span class="o">=</span> <span class="n">sigma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_epsilon</span> <span class="o">=</span> <span class="n">epsilon</span>

        <span class="c1"># shift the energy to 0 at the cutoff</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shift</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">epsilon</span> <span class="o">*</span> <span class="p">((</span><span class="n">sigma</span> <span class="o">/</span> <span class="n">cutoff</span><span class="p">)</span> <span class="o">**</span> <span class="mi">12</span> <span class="o">-</span> <span class="p">(</span><span class="n">sigma</span> <span class="o">/</span> <span class="n">cutoff</span><span class="p">)</span> <span class="o">**</span> <span class="mi">6</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">requested_neighbor_lists</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">NeighborListOptions</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Method declaring which neighbors lists this model desires.</span>

<span class="sd">        The method is required to tell an simulation engine (here ase) to compute and</span>
<span class="sd">        attach the requested neighbor list to a system which will be passed to the</span>
<span class="sd">        ``forward`` method defined below</span>

<span class="sd">        Note that a model can request as many neighbor lists as it wants</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_nl_options</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">systems</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">System</span><span class="p">],</span>
        <span class="n">outputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ModelOutput</span><span class="p">],</span>
        <span class="n">selected_atoms</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Labels</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TensorMap</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">!=</span> <span class="p">[</span><span class="s2">&quot;energy&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;this model can only compute &#39;energy&#39;, but `outputs` contains other &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;keys: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># we don&#39;t want to worry about selected_atoms yet</span>
        <span class="k">if</span> <span class="n">selected_atoms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;selected_atoms is not implemented&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;energy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">per_atom</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;per atom energy is not implemented&quot;</span><span class="p">)</span>

        <span class="c1"># Initialize device so we can access it outside of the for loop</span>
        <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">system</span> <span class="ow">in</span> <span class="n">systems</span><span class="p">:</span>
            <span class="n">device</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">device</span>
            <span class="n">neighbors</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">get_neighbor_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nl_options</span><span class="p">)</span>
            <span class="n">distances</span> <span class="o">=</span> <span class="n">neighbors</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

            <span class="n">sigma_r_6</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sigma</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">vector_norm</span><span class="p">(</span><span class="n">distances</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span> <span class="o">**</span> <span class="mi">6</span>
            <span class="n">sigma_r_12</span> <span class="o">=</span> <span class="n">sigma_r_6</span> <span class="o">*</span> <span class="n">sigma_r_6</span>
            <span class="n">e</span> <span class="o">=</span> <span class="mf">4.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epsilon</span> <span class="o">*</span> <span class="p">(</span><span class="n">sigma_r_12</span> <span class="o">-</span> <span class="n">sigma_r_6</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shift</span>

        <span class="n">samples</span> <span class="o">=</span> <span class="n">Labels</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;system&quot;</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">systems</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">block</span> <span class="o">=</span> <span class="n">TensorBlock</span><span class="p">(</span>
            <span class="n">values</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">samples</span><span class="o">=</span><span class="n">samples</span><span class="p">,</span>
            <span class="n">components</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">List</span><span class="p">[</span><span class="n">Labels</span><span class="p">],</span> <span class="p">[]),</span>
            <span class="n">properties</span><span class="o">=</span><span class="n">Labels</span><span class="p">([</span><span class="s2">&quot;energy&quot;</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)),</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;energy&quot;</span><span class="p">:</span> <span class="n">TensorMap</span><span class="p">(</span>
                <span class="n">Labels</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)),</span> <span class="p">[</span><span class="n">block</span><span class="p">]</span>
            <span class="p">),</span>
        <span class="p">}</span>
</pre></div>
</div>
<p>In the model above, in addition to the required <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> and
<a class="reference internal" href="../../atomistic/reference/models/export.html#metatensor.torch.atomistic.ModelInterface.forward" title="metatensor.torch.atomistic.ModelInterface.forward"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ModelInterface.forward()</span></code></a> methods, we also implemented the
<a class="reference internal" href="../../atomistic/reference/models/export.html#metatensor.torch.atomistic.ModelInterface.requested_neighbor_lists" title="metatensor.torch.atomistic.ModelInterface.requested_neighbor_lists"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ModelInterface.requested_neighbor_lists()</span></code></a> method, which declares the neighbor
list our model requires.</p>
</section>
<section id="running-the-simulation">
<h2>Running the simulation<a class="headerlink" href="#running-the-simulation" title="Link to this heading">¶</a></h2>
<p>We now define and wrap the model, using the initial positions and the Lennard-Jones
parameters taken from <a class="reference external" href="https://dx.doi.org/10.1088/2399-6528/ac62a2">Méndez-Bermúdez et.al, Phys. Commun. 2022</a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <strong>units</strong> of the Lennard Jones parameters from the reference are in
<code class="docutils literal notranslate"><span class="pre">&quot;Angstrom&quot;</span></code> and <code class="docutils literal notranslate"><span class="pre">&quot;kJ/mol&quot;</span></code>. We declare the (energy) <code class="docutils literal notranslate"><span class="pre">unit</span></code> and
<code class="docutils literal notranslate"><span class="pre">length_unit</span></code> accordiningly when defining the <a class="reference internal" href="../../atomistic/reference/models/metadata.html#metatensor.torch.atomistic.ModelCapabilities" title="metatensor.torch.atomistic.ModelCapabilities"><code class="xref py py-class docutils literal notranslate"><span class="pre">ModelCapabilities</span></code></a> object
below. From then on, metatensor is taking care of the correct unit conversion when
the energies and forces are passed to the simulation engine.</p>
</div>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">sigma</span> <span class="o">=</span> <span class="mf">3.3646</span>  <span class="c1"># Å</span>
<span class="n">epsilon</span> <span class="o">=</span> <span class="mf">0.94191</span>  <span class="c1"># kJ / mol</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">LennardJonesModel</span><span class="p">(</span>
    <span class="n">cutoff</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
    <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span>
    <span class="n">epsilon</span><span class="o">=</span><span class="n">epsilon</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">capabilities</span> <span class="o">=</span> <span class="n">ModelCapabilities</span><span class="p">(</span>
    <span class="n">outputs</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;energy&quot;</span><span class="p">:</span> <span class="n">ModelOutput</span><span class="p">(</span><span class="n">quantity</span><span class="o">=</span><span class="s2">&quot;energy&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;kJ/mol&quot;</span><span class="p">,</span> <span class="n">per_atom</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="p">},</span>
    <span class="n">atomic_types</span><span class="o">=</span><span class="p">[</span><span class="mi">18</span><span class="p">],</span>
    <span class="n">interaction_range</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
    <span class="n">length_unit</span><span class="o">=</span><span class="s2">&quot;Angstrom&quot;</span><span class="p">,</span>
    <span class="n">supported_devices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;cpu&quot;</span><span class="p">],</span>
    <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">wrapper</span> <span class="o">=</span> <span class="n">MetatensorAtomisticModel</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">(),</span> <span class="n">ModelMetadata</span><span class="p">(),</span> <span class="n">capabilities</span><span class="p">)</span>

<span class="c1"># Use the wrapped model as the calculator for these atoms</span>
<span class="n">atoms</span><span class="o">.</span><span class="n">calc</span> <span class="o">=</span> <span class="n">MetatensorCalculator</span><span class="p">(</span><span class="n">wrapper</span><span class="p">)</span>
</pre></div>
</div>
<p>We’ll run the simulation in the constant volume/temperature thermodynamic ensemble
(NVT or Canonical ensemble), using a Langevin thermostat for time integration. Please
refer to the corresponding documentation (<a class="reference external" href="https://wiki.fysik.dtu.dk/ase/ase/md.html#ase.md.langevin.Langevin" title="(in ASE)"><code class="xref py py-class docutils literal notranslate"><span class="pre">ase.md.langevin.Langevin</span></code></a>) for
more information!</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">integrator</span> <span class="o">=</span> <span class="n">ase</span><span class="o">.</span><span class="n">md</span><span class="o">.</span><span class="n">Langevin</span><span class="p">(</span>
    <span class="n">atoms</span><span class="p">,</span>
    <span class="n">timestep</span><span class="o">=</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">ase</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">fs</span><span class="p">,</span>
    <span class="n">temperature_K</span><span class="o">=</span><span class="mf">94.4</span><span class="p">,</span>
    <span class="n">friction</span><span class="o">=</span><span class="mf">0.1</span> <span class="o">/</span> <span class="n">ase</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">fs</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">trajectory</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">50</span><span class="p">):</span>
    <span class="c1"># run a single simulation for 10 steps</span>
    <span class="n">integrator</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

    <span class="c1"># collect data about the simulation</span>
    <span class="n">trajectory</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atoms</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
</pre></div>
</div>
<p>We can use <a class="reference external" href="https://chemiscope.org">chemiscope</a> to visualize the trajectory</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">viewer_settings</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;bonds&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;playbackDelay&quot;</span><span class="p">:</span> <span class="mi">70</span><span class="p">}</span>
<span class="n">chemiscope</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">trajectory</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;structure&quot;</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;structure&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">viewer_settings</span><span class="p">]})</span>
</pre></div>
</div>
<!-- begin headers -->
<!-- Load all dependencies -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.4/pako.min.js"></script>

<!-- JS scripts -->
<script src="../../_static/chemiscope.min.js"></script>
<script src="../../_static/chemiscope-sphinx.js"></script>

<!-- CSS styles -->
<link rel="stylesheet" href="../../_static/chemiscope-sphinx.css" type="text/css" />
<!-- end headers -->

<!-- Warning Display -->
<div id="chsp-7920ee33-0625-484d-84ad-8c664a956ce4-warning-display" class="chemiscope-sphinx-warning">
    <p></p>
    <button type="button" aria-label="Close" onclick="hideElement('chsp-7920ee33-0625-484d-84ad-8c664a956ce4-warning-display')">
        &times;
    </button>
</div>
<div style="padding: 0.5rem 1.25rem" />

<!-- Loading Spinner -->
<div id="chsp-7920ee33-0625-484d-84ad-8c664a956ce4-loading" class="chemiscope-sphinx-spinner">
    <img src="../../_static/chemiscope-loading.svg" alt="Loading icon" />
</div>

<!-- Chemiscope Visualization -->
<div id="chsp-7920ee33-0625-484d-84ad-8c664a956ce4">
    <!-- This will be replaced by the chemiscope HTML -->
</div>

<!-- Load Visualization Script -->
<script>
    loadChemiscopeSphinx('chsp-7920ee33-0625-484d-84ad-8c664a956ce4', '../../_datasets/3af5fbd85cd6d5a01138851b247101374df2b01e5e4d1276c4324c72c3a8cd18-fig_3-atomistic-model-with-nl_002.json.gz', 'structure');
</script>
<div class="output_subarea output_html rendered_html output_result">

</div>
<br />
<br /><p>We finally compute and plot the avaregae pair-correlation function <span class="math notranslate nohighlight">\(g(r)\)</span> of the
recorded <code class="docutils literal notranslate"><span class="pre">trajectory</span></code>.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">rdf</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">atoms</span> <span class="ow">in</span> <span class="n">trajectory</span><span class="p">:</span>
    <span class="n">rdf_step</span><span class="p">,</span> <span class="n">rdf_dists</span> <span class="o">=</span> <span class="n">ase</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">rdf</span><span class="o">.</span><span class="n">get_rdf</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">rmax</span><span class="o">=</span><span class="mf">9.0</span><span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">rdf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rdf_step</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rdf_dists</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rdf</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;distance / Å&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$g(r)$&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">minorticks_on</span><span class="p">()</span>

<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_3-atomistic-model-with-nl_002.png" srcset="../../_images/sphx_glr_3-atomistic-model-with-nl_002.png" alt="3 atomistic model with nl" class = "sphx-glr-single-img"/><p>The pair-correlation function shows the usual structure for a liquid and we find the
expected first narrow peak at 3.7 Å and a second broader peak at 7.0 Å.</p>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> (0 minutes 3.351 seconds)</p>
<div class="sphx-glr-footer sphx-glr-footer-example docutils container" id="sphx-glr-download-examples-atomistic-3-atomistic-model-with-nl-py">
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/7221e901f0ec6dcfb6ab22469434ec38/3-atomistic-model-with-nl.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">3-atomistic-model-with-nl.ipynb</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/f1e1a3a74b4c58d44ad28affc2544e29/3-atomistic-model-with-nl.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">3-atomistic-model-with-nl.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-zip docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/3091efc2e0267bb4ad181ba6dc0a81cd/3-atomistic-model-with-nl.zip"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">zipped:</span> <span class="pre">3-atomistic-model-with-nl.zip</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="4-profiling.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Profiling your models</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="2-running-ase-md.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Running Molecular Dynamics with ASE</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2025, the metatensor developers
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Creating models that use neighbor lists</a><ul>
<li><a class="reference internal" href="#the-simulation-system">The simulation system</a></li>
<li><a class="reference internal" href="#metatensor-s-neighbor-lists">Metatensor’s neighbor lists</a><ul>
<li><a class="reference internal" href="#creating-a-neighbor-list">Creating a neighbor list</a></li>
<li><a class="reference internal" href="#accessing-data-in-neighbor-lists">Accessing data in neighbor lists</a></li>
</ul>
</li>
<li><a class="reference internal" href="#a-lennard-jones-model">A Lennard-Jones model</a></li>
<li><a class="reference internal" href="#running-the-simulation">Running the simulation</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/furo.js?v=5fa4622c"></script>
    <script src="../../_static/toggleprompt.js?v=5801b3bb"></script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../_static/js/custom.js?v=4b1677b9"></script>
    <script data-domain="docs.metatensor.org" defer="defer" src="https://plausible.io/js/script.js"></script>
    </body>
</html>