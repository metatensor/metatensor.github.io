<!doctype html>
<html class="no-js" lang="en" data-content_root="../../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" /><link rel="next" title="Changelog" href="../../core/CHANGELOG.html" /><link rel="prev" title="Handling sparsity" href="2-handling-sparsity.html" />

    <!-- Generated with Sphinx 7.2.6 and Furo 2024.05.06 -->
        <title>Managing gradients - Metatensor</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=387cc868" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/metatensor.css?v=d517da54" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css?v=61a4c737" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-binder.css?v=f4aeca0c" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-dataframe.css?v=2082cf3c" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=36a5483c" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" /
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">Metatensor</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  
  
  <span class="sidebar-brand-text">Metatensor</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../goals.html">Metatensor’s goals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="../../core/index.html">Core classes</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Core classes</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../core/overview.html">Overview</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../core/reference/python/index.html">Python API reference</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Python API reference</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../core/reference/python/tensor.html">TensorMap</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../core/reference/python/block.html">TensorBlock</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../core/reference/python/labels.html">Labels</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../core/reference/python/io.html">Serialization</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../core/reference/python/data.html">Data arrays</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../core/reference/python/misc.html">Miscellaneous</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../core/reference/cxx/index.html">C++ API reference</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of C++ API reference</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../core/reference/cxx/tensor.html">TensorMap</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../core/reference/cxx/labels.html">Labels</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../core/reference/cxx/block.html">TensorBlock</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../core/reference/cxx/data.html">Data arrays</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../core/reference/cxx/misc.html">Miscellaneous</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../core/reference/c/index.html">C API reference</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of C API reference</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../core/reference/c/tensor.html">TensorMap</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../core/reference/c/labels.html">Labels</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../core/reference/c/block.html">TensorBlock</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../core/reference/c/data.html">Data arrays</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../core/reference/c/misc.html">Miscellaneous</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../core/reference/rust/index.html">Rust API reference</a></li>
<li class="toctree-l2 current has-children"><a class="reference internal" href="index.html">Tutorials</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle navigation of Tutorials</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="1-first-steps.html">First steps with metatensor</a></li>
<li class="toctree-l3"><a class="reference internal" href="2-handling-sparsity.html">Handling sparsity</a></li>
<li class="toctree-l3 current current-page"><a class="current reference internal" href="#">Managing gradients</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../core/CHANGELOG.html">Changelog</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../operations/index.html">Operations</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle navigation of Operations</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../operations/torch.html">Operations and PyTorch</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../operations/reference/index.html">API reference</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><div class="visually-hidden">Toggle navigation of API reference</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../operations/reference/creation/index.html">Creation operations</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" role="switch" type="checkbox"/><label for="toctree-checkbox-8"><div class="visually-hidden">Toggle navigation of Creation operations</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/creation/empty_like.html">empty_like()</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/creation/ones_like.html">ones_like()</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/creation/zeros_like.html">zeros_like()</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/creation/random_like.html">random_like()</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/creation/block_from_array.html">block_from_array()</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../operations/reference/linear_algebra/index.html">Linear algebra</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" role="switch" type="checkbox"/><label for="toctree-checkbox-9"><div class="visually-hidden">Toggle navigation of Linear algebra</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/linear_algebra/dot.html">dot()</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/linear_algebra/lstsq.html">lstsq()</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/linear_algebra/solve.html">solve()</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../operations/reference/logic/index.html">Logic function</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" role="switch" type="checkbox"/><label for="toctree-checkbox-10"><div class="visually-hidden">Toggle navigation of Logic function</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/logic/allclose.html">allclose()</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/logic/equal.html">equal()</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/logic/equal_metadata.html">equal_metadata()</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../operations/reference/manipulation/index.html">Manipulation operations</a><input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" role="switch" type="checkbox"/><label for="toctree-checkbox-11"><div class="visually-hidden">Toggle navigation of Manipulation operations</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/manipulation/detach.html">detach()</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/manipulation/drop-blocks.html">drop_blocks()</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/manipulation/join.html">join()</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/manipulation/manipulate-dimension.html">manipulate dimension</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/manipulation/one-hot.html">one_hot()</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/manipulation/remove-gradients.html">remove_gradients()</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/manipulation/requires-grad.html">requires_grad()</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/manipulation/samples-reduction.html">samples reduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/manipulation/slice.html">slice()</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/manipulation/split.html">split()</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../operations/reference/math/index.html">Mathematical functions</a><input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" role="switch" type="checkbox"/><label for="toctree-checkbox-12"><div class="visually-hidden">Toggle navigation of Mathematical functions</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/math/abs.html">abs()</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/math/add.html">add()</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/math/divide.html">divide()</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/math/multiply.html">multiply()</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/math/pow.html">pow()</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/math/subtract.html">subtract()</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../operations/reference/set/index.html">Set operations</a><input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" role="switch" type="checkbox"/><label for="toctree-checkbox-13"><div class="visually-hidden">Toggle navigation of Set operations</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/set/unique_metadata.html">unique_metadata()</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../operations/reference/set/sort.html">sort()</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/reference/checks.html">Checks</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../operations/CHANGELOG.html">Changelog</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../torch/index.html">TorchScript backend</a><input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" role="switch" type="checkbox"/><label for="toctree-checkbox-14"><div class="visually-hidden">Toggle navigation of TorchScript backend</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../torch/reference/index.html">API reference</a><input class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" role="switch" type="checkbox"/><label for="toctree-checkbox-15"><div class="visually-hidden">Toggle navigation of API reference</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../torch/reference/tensor.html">TensorMap</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../torch/reference/block.html">TensorBlock</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../torch/reference/labels.html">Labels</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../torch/reference/serialization.html">Serialization</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../torch/reference/cxx/index.html">TorchScript C++ API reference</a><input class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" role="switch" type="checkbox"/><label for="toctree-checkbox-16"><div class="visually-hidden">Toggle navigation of TorchScript C++ API reference</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../torch/reference/cxx/tensor.html">TensorMap</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../torch/reference/cxx/block.html">TensorBlock</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../torch/reference/cxx/labels.html">Labels</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../torch/reference/cxx/miscellaneous.html">Miscellaneous</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../torch/CHANGELOG.html">Changelog</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../learn/index.html">Learning utilities</a><input class="toctree-checkbox" id="toctree-checkbox-17" name="toctree-checkbox-17" role="switch" type="checkbox"/><label for="toctree-checkbox-17"><div class="visually-hidden">Toggle navigation of Learning utilities</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../learn/reference/index.html">API reference</a><input class="toctree-checkbox" id="toctree-checkbox-18" name="toctree-checkbox-18" role="switch" type="checkbox"/><label for="toctree-checkbox-18"><div class="visually-hidden">Toggle navigation of API reference</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../learn/reference/data/index.html">Data utilites</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../learn/reference/nn/index.html">Neural Network</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../learn/index.html">Tutorials</a><input class="toctree-checkbox" id="toctree-checkbox-19" name="toctree-checkbox-19" role="switch" type="checkbox"/><label for="toctree-checkbox-19"><div class="visually-hidden">Toggle navigation of Tutorials</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../learn/1-dataset-dataloader.html">Datasets and data loaders</a></li>
<li class="toctree-l3"><a class="reference internal" href="../learn/2-indexed-dataset.html">Using IndexedDataset</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../learn/CHANGELOG.html">Changelog</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../atomistic/index.html">Atomistic applications</a><input class="toctree-checkbox" id="toctree-checkbox-20" name="toctree-checkbox-20" role="switch" type="checkbox"/><label for="toctree-checkbox-20"><div class="visually-hidden">Toggle navigation of Atomistic applications</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../atomistic/overview.html">Overview</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../atomistic/reference/index.html">API reference</a><input class="toctree-checkbox" id="toctree-checkbox-21" name="toctree-checkbox-21" role="switch" type="checkbox"/><label for="toctree-checkbox-21"><div class="visually-hidden">Toggle navigation of API reference</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../atomistic/reference/systems.html">Systems</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../atomistic/reference/models/index.html">Models</a><input class="toctree-checkbox" id="toctree-checkbox-22" name="toctree-checkbox-22" role="switch" type="checkbox"/><label for="toctree-checkbox-22"><div class="visually-hidden">Toggle navigation of Models</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../atomistic/reference/models/export.html">Exporting models</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../atomistic/reference/models/metadata.html">Information about models</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../atomistic/reference/ase.html">Atomic Simulation Environment (ASE) integration</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../atomistic/reference/cxx/index.html">C++ API reference</a><input class="toctree-checkbox" id="toctree-checkbox-23" name="toctree-checkbox-23" role="switch" type="checkbox"/><label for="toctree-checkbox-23"><div class="visually-hidden">Toggle navigation of C++ API reference</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../atomistic/reference/cxx/systems.html">Systems</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../atomistic/reference/cxx/models.html">Models</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../atomistic/outputs.html">Standard model outputs</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../atomistic/index.html">Tutorials</a><input class="toctree-checkbox" id="toctree-checkbox-24" name="toctree-checkbox-24" role="switch" type="checkbox"/><label for="toctree-checkbox-24"><div class="visually-hidden">Toggle navigation of Tutorials</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../atomistic/1-export-atomistic-model.html">Exporting a model</a></li>
<li class="toctree-l3"><a class="reference internal" href="../atomistic/2-running-ase-md.html">Running Molecular Dynamics with ASE</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../devdoc/index.html">Developer documentation</a><input class="toctree-checkbox" id="toctree-checkbox-25" name="toctree-checkbox-25" role="switch" type="checkbox"/><label for="toctree-checkbox-25"><div class="visually-hidden">Toggle navigation of Developer documentation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../devdoc/get-started.html">Getting started</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../devdoc/architecture.html">Code organization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../devdoc/versions.html">Version number management</a></li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="../../_sources/examples/core/3-managing-gradients.rst.txt" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div>
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference internal" href="#sphx-glr-download-examples-core-3-managing-gradients-py"><span class="std std-ref">Go to the end</span></a>
to download the full example code.</p>
</div>
<section class="sphx-glr-example-title" id="managing-gradients">
<span id="core-tutorial-gradients"></span><span id="sphx-glr-examples-core-3-managing-gradients-py"></span><h1>Managing gradients<a class="headerlink" href="#managing-gradients" title="Link to this heading">¶</a></h1>
<p>Another big difference between metatensor and other more generic data storage formats is
its ability to store and manipulate one or more gradients of the data together with the
data itself. In this tutorial, we will see how and where gradients are stored, and what
one can do with them.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Metatensor supports multiple ways of managing gradients: explicit forward gradients,
presented in this tutorial; and implicit backward mode gradients (only when the data
is stored in <a class="reference external" href="https://pytorch.org/docs/stable/tensors.html#torch.Tensor" title="(in PyTorch v2.3)"><code class="xref py py-class docutils literal notranslate"><span class="pre">torch.Tensor</span></code></a>). Both can be mixed as well, to compute
backward mode gradients of explicit forward mode gradients when training a model
with gradient data (forces and virial).</p>
<p>In general, the explicit forward gradients presented here are mainly relevant to you
if you are working within the numpy ecosystem; and the implicit backward gradients
are more interesting if you are working in the PyTorch ecosystem.</p>
</div>
<p>The code used to generate <a class="reference download internal" download="" href="../../_downloads/156efef7baa6447c637e3e09f48fc01f/spherical-expansion.npz"><code class="xref download docutils literal notranslate"><span class="pre">spherical-expansion.npz</span></code></a> is in <a class="reference internal" href="1-first-steps.html#core-tutorial-first-steps"><span class="std std-ref">the first
tutorial</span></a>, and the code for <a class="reference download internal" download="" href="../../_downloads/0cc0ba974aa15743303d66de4a7f7bb9/radial-spectrum.npz"><code class="xref download docutils literal notranslate"><span class="pre">radial-spectrum.npz</span></code></a>
is shown <a class="reference internal" href="2-handling-sparsity.html#core-tutorial-sparsity"><span class="std std-ref">in the second</span></a>. Notice how in both cases, the
data was computed with <code class="docutils literal notranslate"><span class="pre">gradients=[&quot;positions&quot;]</span></code>, meaning the gradients with respect
to atomic positions are included.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">metatensor</span>
<span class="kn">from</span> <span class="nn">metatensor</span> <span class="kn">import</span> <span class="n">TensorBlock</span><span class="p">,</span> <span class="n">TensorMap</span>
</pre></div>
</div>
<section id="amazing-gradients-and-where-to-find-them">
<h2>Amazing gradients and where to find them<a class="headerlink" href="#amazing-gradients-and-where-to-find-them" title="Link to this heading">¶</a></h2>
<p>In the first <a class="reference internal" href="1-first-steps.html#core-tutorial-first-steps"><span class="std std-ref">tutorial</span></a>, we have seen how metatensor
stores data and metadata together inside <a class="reference internal" href="../../core/reference/python/block.html#metatensor.TensorBlock" title="metatensor.TensorBlock"><code class="xref py py-class docutils literal notranslate"><span class="pre">TensorBlock</span></code></a>; and groups multiple
blocks to form a full <a class="reference internal" href="../../core/reference/python/tensor.html#metatensor.TensorMap" title="metatensor.TensorMap"><code class="xref py py-class docutils literal notranslate"><span class="pre">TensorMap</span></code></a>. To refresh our memory, let’s load some
data (the radial spectrum from the <a class="reference internal" href="2-handling-sparsity.html#core-tutorial-sparsity"><span class="std std-ref">sparsity tutorial</span></a>).
It is a tensor map with two dimensions for the keys; and 5 blocks:</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">radial_spectrum</span> <span class="o">=</span> <span class="n">metatensor</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;radial-spectrum.npz&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">radial_spectrum</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>TensorMap with 5 blocks
keys: center_type  neighbor_type
           6             6
           6             8
           7             7
           8             6
           8             8
</pre></div>
</div>
<p>If we look at one of the block, we can see that is contains gradients with respect to
<code class="docutils literal notranslate"><span class="pre">&quot;positions&quot;</span></code>:</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">block</span> <span class="o">=</span> <span class="n">radial_spectrum</span><span class="o">.</span><span class="n">block</span><span class="p">(</span><span class="n">center_type</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">neighbor_type</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>TensorBlock
    samples (2): [&#39;system&#39;, &#39;atom&#39;]
    components (): []
    properties (3): [&#39;n&#39;]
    gradients: [&#39;positions&#39;]
</pre></div>
</div>
<p>Gradients are stored inside normal <a class="reference internal" href="../../core/reference/python/block.html#metatensor.TensorBlock" title="metatensor.TensorBlock"><code class="xref py py-class docutils literal notranslate"><span class="pre">TensorBlock</span></code></a>, with their own set of
metadata in the samples, components and properties dimensions.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">gradient</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="s2">&quot;positions&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">gradient</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Gradient TensorBlock (&#39;positions&#39;)
    samples (4): [&#39;sample&#39;, &#39;system&#39;, &#39;atom&#39;]
    components (3): [&#39;xyz&#39;]
    properties (3): [&#39;n&#39;]
    gradients: None
</pre></div>
</div>
<p>The samples are different from the values blocks (the block to which this gradient it
attached to): there is a first <code class="docutils literal notranslate"><span class="pre">&quot;sample&quot;</span></code> dimension, followed by a pair of indices
<code class="docutils literal notranslate"><span class="pre">(structure,</span> <span class="pre">atom)</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">&quot;sample&quot;</span></code> dimension is always present in gradients, and indicate which of the
samples in the values block we are taking the gradient of. Here, the first row of the
gradients will contain a gradient of the first sample in the values; with respect to
the position of atom 4; while the last row of the gradients contains a gradient of the
second row of the values with respect to the position of atom 5.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">gradient</span><span class="o">.</span><span class="n">samples</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Labels(
    sample  system  atom
      0       0      4
      0       0      5
      1       0      4
      1       0      5
)
</pre></div>
</div>
<p>Re-using the notation from the previous tutorial, the values contain <span class="math notranslate nohighlight">\(\rho_i\)</span>,
for a given atomic center <span class="math notranslate nohighlight">\(i\)</span>.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">samples</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Labels(
    system  atom
      0      4
      0      5
)
</pre></div>
</div>
<p>If we look a the samples for the values, we can express the four samples in this
gradient block as</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(\nabla_4 \rho_4\)</span>: gradient of the representation of atom 4 with respect to
the position of atom 4;</p></li>
<li><p><span class="math notranslate nohighlight">\(\nabla_5 \rho_4\)</span>: gradient of the representation of atom 4 with respect to
the position of atom 5;</p></li>
<li><p><span class="math notranslate nohighlight">\(\nabla_4 \rho_5\)</span>: gradient of the representation of atom 5 with respect to
the position of atom 4;</p></li>
<li><p><span class="math notranslate nohighlight">\(\nabla_5 \rho_5\)</span>: gradient of the representation of atom 5 with respect to
the position of atom 5.</p></li>
</ul>
<p>You’ll realize that some of the combinations of atoms are missing here: there is no
gradient of <span class="math notranslate nohighlight">\(\rho_4\)</span> with respect to the positions of atom 0, 1, 2, <em>etc.</em> This
is another instance of the data sparsity that metatensor enable: only the non-zero
gradients are actually stored in memory.</p>
<figure class="align-center" id="id1">
<a class="reference internal image-reference" href="../../_images/TensorBlock-Gradients.svg"><img alt="../../_images/TensorBlock-Gradients.svg" src="../../_images/TensorBlock-Gradients.svg" width="400px" /></a>
<figcaption>
<p><span class="caption-text">Visual illustration of the gradients, and how multiple gradient row/gradient
samples can correspond to the same row/sample in the values.</span><a class="headerlink" href="#id1" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<p>The gradient block can also differ from the values block in the components: here the
values have no components, but the gradient have one, representing the x/y/z cartesian
coordinate direction of the gradient with respect to positions.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">gradient</span><span class="o">.</span><span class="n">components</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>[Labels(
    xyz
     0
     1
     2
)]
</pre></div>
</div>
<p>Finally, the gradient properties are guaranteed to be the same as the values
properties.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">properties</span> <span class="o">==</span> <span class="n">gradient</span><span class="o">.</span><span class="n">properties</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
<p>The gradient block also contains the data for the gradient, in the <code class="docutils literal notranslate"><span class="pre">values</span></code>
attribute. Here the gradients are zeros everywhere except in the x direction because
in the original input, the N<sub>2</sub> molecule was oriented along the x axis.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">gradient</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>[[[ 0.17209336  0.08442732 -0.09967984]
  [ 0.          0.          0.        ]
  [ 0.          0.          0.        ]]

 [[-0.17209336 -0.08442732  0.09967984]
  [ 0.          0.          0.        ]
  [ 0.          0.          0.        ]]

 [[ 0.17209336  0.08442732 -0.09967984]
  [ 0.          0.          0.        ]
  [ 0.          0.          0.        ]]

 [[-0.17209336 -0.08442732  0.09967984]
  [ 0.          0.          0.        ]
  [ 0.          0.          0.        ]]]
</pre></div>
</div>
</section>
<section id="what-if-the-values-have-components">
<h2>What if the values have components?<a class="headerlink" href="#what-if-the-values-have-components" title="Link to this heading">¶</a></h2>
<p>We have seen that the gradient samples are related to the values samples with the
<code class="docutils literal notranslate"><span class="pre">sample</span></code> dimension; and that the gradient are allowed to have custom <code class="docutils literal notranslate"><span class="pre">components</span></code>.
You might be wondering what happen if the values already have some components!</p>
<p>Let’s load such an example, the spherical expansion from the <a class="reference internal" href="1-first-steps.html#core-tutorial-first-steps"><span class="std std-ref">first steps
tutorial</span></a>:</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">spherical_expansion</span> <span class="o">=</span> <span class="n">metatensor</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;spherical-expansion.npz&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">spherical_expansion</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>TensorMap with 12 blocks
keys: o3_lambda  o3_sigma  center_type  neighbor_type
          0         1           6             6
          1         1           6             6
          2         1           6             6
          0         1           6             8
          1         1           6             8
          2         1           6             8
          0         1           8             6
          1         1           8             6
          2         1           8             6
          0         1           8             8
          1         1           8             8
          2         1           8             8
</pre></div>
</div>
<p>In the <a class="reference internal" href="../../core/reference/python/tensor.html#metatensor.TensorMap" title="metatensor.TensorMap"><code class="xref py py-class docutils literal notranslate"><span class="pre">TensorMap</span></code></a> above, the value blocks already have a set of components
corresponding to the <span class="math notranslate nohighlight">\(m\)</span> index of spherical harmonics:</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">block</span> <span class="o">=</span> <span class="n">spherical_expansion</span><span class="o">.</span><span class="n">block</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">components</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>[Labels(
    o3_mu
     -2
     -1
      0
      1
      2
)]
</pre></div>
</div>
<p>If we look at the gradients with respect to positions, we see that they contain two
sets of components: the same <code class="docutils literal notranslate"><span class="pre">xyz</span></code> component as the radial spectrum example
earlier; and the same <code class="docutils literal notranslate"><span class="pre">o3_mu</span></code> as the values.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">gradient</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="s2">&quot;positions&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">gradient</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Gradient TensorBlock (&#39;positions&#39;)
    samples (1): [&#39;sample&#39;, &#39;system&#39;, &#39;atom&#39;]
    components (3, 5): [&#39;xyz&#39;, &#39;o3_mu&#39;]
    properties (5): [&#39;n&#39;]
    gradients: None
</pre></div>
</div>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;first set of components:&quot;</span><span class="p">,</span> <span class="n">gradient</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;second set of components:&quot;</span><span class="p">,</span> <span class="n">gradient</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>first set of components: Labels(
    xyz
     0
     1
     2
)
second set of components: Labels(
    o3_mu
     -2
     -1
       ...
      1
      2
)
</pre></div>
</div>
<p>In general, the gradient blocks are allowed to have additional components when
compared to the values, but these extra components must come first, and are followed
by the same set of components as the values.</p>
</section>
<section id="using-gradients-in-calculations">
<h2>Using gradients in calculations<a class="headerlink" href="#using-gradients-in-calculations" title="Link to this heading">¶</a></h2>
<p>Now that we know about gradient storage in metatensor, we should try to compute a new
set of values and their corresponding gradients.</p>
<p>Let’s compute the square of the radial spectrum, <span class="math notranslate nohighlight">\(h(r) = \rho^2(r)\)</span>, and the
corresponding gradients with respect to atomic positions. The chain rules tells us
that the gradient should be</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\nabla h(r) = 2\ \rho(r) * \nabla \rho(r)\]</div>
</div>
<p>Since the calculation can happen block by block, let’s define a function to compute a
new <span class="math notranslate nohighlight">\(h(r)\)</span> block:</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_square</span><span class="p">(</span><span class="n">block</span><span class="p">:</span> <span class="n">TensorBlock</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TensorBlock</span><span class="p">:</span>
    <span class="c1"># compute the new values</span>
    <span class="n">new_values</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">values</span><span class="o">**</span><span class="mi">2</span>

    <span class="c1"># store the new values in a block</span>
    <span class="n">new_block</span> <span class="o">=</span> <span class="n">TensorBlock</span><span class="p">(</span>
        <span class="n">values</span><span class="o">=</span><span class="n">new_values</span><span class="p">,</span>
        <span class="n">samples</span><span class="o">=</span><span class="n">block</span><span class="o">.</span><span class="n">samples</span><span class="p">,</span>
        <span class="n">components</span><span class="o">=</span><span class="n">block</span><span class="o">.</span><span class="n">components</span><span class="p">,</span>
        <span class="n">properties</span><span class="o">=</span><span class="n">block</span><span class="o">.</span><span class="n">properties</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># compute the new gradient</span>
    <span class="n">gradient</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="s2">&quot;positions&quot;</span><span class="p">)</span>

    <span class="c1"># `block.values[gradient.samples[&quot;sample&quot;]]` gives us an array with a shape</span>
    <span class="c1"># compatible with `gradient.values`; using the right row in the values to compute</span>
    <span class="c1"># the a given row of the gradients. ``None`` creates an additional dimension to</span>
    <span class="c1"># match the components of the gradients.</span>
    <span class="n">broadcasted_values</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">gradient</span><span class="o">.</span><span class="n">samples</span><span class="p">[</span><span class="s2">&quot;sample&quot;</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">new_gradient_values</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">broadcasted_values</span> <span class="o">*</span> <span class="n">gradient</span><span class="o">.</span><span class="n">values</span>

    <span class="n">new_gradient</span> <span class="o">=</span> <span class="n">TensorBlock</span><span class="p">(</span>
        <span class="n">values</span><span class="o">=</span><span class="n">new_gradient_values</span><span class="p">,</span>
        <span class="n">samples</span><span class="o">=</span><span class="n">gradient</span><span class="o">.</span><span class="n">samples</span><span class="p">,</span>
        <span class="n">components</span><span class="o">=</span><span class="n">gradient</span><span class="o">.</span><span class="n">components</span><span class="p">,</span>
        <span class="n">properties</span><span class="o">=</span><span class="n">gradient</span><span class="o">.</span><span class="n">properties</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># store the gradient in the new block</span>
    <span class="n">new_block</span><span class="o">.</span><span class="n">add_gradient</span><span class="p">(</span><span class="s2">&quot;positions&quot;</span><span class="p">,</span> <span class="n">new_gradient</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">new_block</span>
</pre></div>
</div>
<p>One issue when applying the equation above blindly is that <code class="docutils literal notranslate"><span class="pre">block.values</span></code> (i.e.
<span class="math notranslate nohighlight">\(\rho(r)\)</span>) and <code class="docutils literal notranslate"><span class="pre">gradient.values</span></code> (i.e. <span class="math notranslate nohighlight">\(\nabla \rho(r)\)</span>) have different
shape. Fortunately, we already know how to match them: <code class="docutils literal notranslate"><span class="pre">gradient.samples[&quot;sample&quot;]</span></code>
contains the indices of <code class="docutils literal notranslate"><span class="pre">block.values</span></code> matching each row of <code class="docutils literal notranslate"><span class="pre">gradient.values</span></code>.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">gradient</span> <span class="o">=</span> <span class="n">radial_spectrum</span><span class="o">.</span><span class="n">block</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="s2">&quot;positions&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">gradient</span><span class="o">.</span><span class="n">samples</span><span class="p">[</span><span class="s2">&quot;sample&quot;</span><span class="p">])</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>[0 0 1 1]
</pre></div>
</div>
<p>We can now apply this function on all the blocks, and reconstruct a new
<a class="reference internal" href="../../core/reference/python/tensor.html#metatensor.TensorMap" title="metatensor.TensorMap"><code class="xref py py-class docutils literal notranslate"><span class="pre">TensorMap</span></code></a>:</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">blocks</span> <span class="o">=</span> <span class="p">[</span><span class="n">compute_square</span><span class="p">(</span><span class="n">block</span><span class="p">)</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">radial_spectrum</span><span class="o">.</span><span class="n">blocks</span><span class="p">()]</span>
<span class="n">squared</span> <span class="o">=</span> <span class="n">TensorMap</span><span class="p">(</span><span class="n">keys</span><span class="o">=</span><span class="n">radial_spectrum</span><span class="o">.</span><span class="n">keys</span><span class="p">,</span> <span class="n">blocks</span><span class="o">=</span><span class="n">blocks</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">squares</span></code> has the same shape and sparsity pattern as <code class="docutils literal notranslate"><span class="pre">radial_spectrum</span></code>, but
contains different values:</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">squared</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>TensorMap with 5 blocks
keys: center_type  neighbor_type
           6             6
           6             8
           7             7
           8             6
           8             8
</pre></div>
</div>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">rs_block</span> <span class="o">=</span> <span class="n">radial_spectrum</span><span class="o">.</span><span class="n">block</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">squared_block</span> <span class="o">=</span> <span class="n">squared</span><span class="o">.</span><span class="n">block</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;radial_spectrum block:&quot;</span><span class="p">,</span> <span class="n">rs_block</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;square block:&quot;</span><span class="p">,</span> <span class="n">squared_block</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>radial_spectrum block: TensorBlock
    samples (2): [&#39;system&#39;, &#39;atom&#39;]
    components (): []
    properties (3): [&#39;n&#39;]
    gradients: [&#39;positions&#39;]
square block: TensorBlock
    samples (2): [&#39;system&#39;, &#39;atom&#39;]
    components (): []
    properties (3): [&#39;n&#39;]
    gradients: [&#39;positions&#39;]
</pre></div>
</div>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;radial_spectrum values:&quot;</span><span class="p">,</span> <span class="n">rs_block</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;square values:&quot;</span><span class="p">,</span> <span class="n">squared_block</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>radial_spectrum values: [[ 0.58644107 -0.15682146  0.03612176]
 [ 0.58644107 -0.15682146  0.03612176]]
square values: [[0.34391313 0.02459297 0.00130478]
 [0.34391313 0.02459297 0.00130478]]
</pre></div>
</div>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;radial_spectrum gradient:&quot;</span><span class="p">,</span> <span class="n">rs_block</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="s2">&quot;positions&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;square gradient:&quot;</span><span class="p">,</span> <span class="n">squared_block</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="s2">&quot;positions&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>radial_spectrum gradient: [[ 0.17209336  0.08442732 -0.09967984]
 [-0.17209336 -0.08442732  0.09967984]
 [ 0.17209336  0.08442732 -0.09967984]
 [-0.17209336 -0.08442732  0.09967984]]
square gradient: [[ 0.20184523 -0.02648003 -0.00720122]
 [-0.20184523  0.02648003  0.00720122]
 [ 0.20184523 -0.02648003 -0.00720122]
 [-0.20184523  0.02648003  0.00720122]]
</pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>We provide many functions that operate on <a class="reference internal" href="../../core/reference/python/tensor.html#metatensor.TensorMap" title="metatensor.TensorMap"><code class="xref py py-class docutils literal notranslate"><span class="pre">TensorMap</span></code></a> and
<a class="reference internal" href="../../core/reference/python/block.html#metatensor.TensorBlock" title="metatensor.TensorBlock"><code class="xref py py-class docutils literal notranslate"><span class="pre">TensorBlock</span></code></a> as part of the <a class="reference internal" href="../../operations/index.html#metatensor-operations"><span class="std std-ref">metatensor-operations</span></a> module (installed by default with the main
<code class="docutils literal notranslate"><span class="pre">metatensor</span></code> package). These operations already support the different sparsity
levels of metatensor, and support for explicit forward gradients. In general you
will not have to write the type of code from this tutorial yourself, and you
should use the corresponding operation.</p>
<p>For example, <code class="docutils literal notranslate"><span class="pre">squared</span></code> from this tutorial can be calculated with:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">squared</span> <span class="o">=</span> <span class="n">metatensor</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">radial_spectrum</span><span class="p">,</span> <span class="n">radial_spectrum</span><span class="p">)</span>

<span class="c1"># alternatively</span>
<span class="n">squared</span> <span class="o">=</span> <span class="n">metatensor</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">radial_spectrum</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">squared_operations</span> <span class="o">=</span> <span class="n">metatensor</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">radial_spectrum</span><span class="p">,</span> <span class="n">radial_spectrum</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">metatensor</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">squared_operations</span><span class="p">,</span> <span class="n">squared</span><span class="p">))</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> (0 minutes 0.024 seconds)</p>
<div class="sphx-glr-footer sphx-glr-footer-example docutils container" id="sphx-glr-download-examples-core-3-managing-gradients-py">
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/169f24782359888b3d3f9ba55252fb47/3-managing-gradients.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">3-managing-gradients.ipynb</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/77cf17f17521acbffbf24a8c8b5deace/3-managing-gradients.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">3-managing-gradients.py</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="../../core/CHANGELOG.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Changelog</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="2-handling-sparsity.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Handling sparsity</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2024, Guillaume Fraux, Davide Tisi, Philip Loche, Joseph W. Abbott, Jigyasa Nigam, Chiheb Ben Mahmoud
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Managing gradients</a><ul>
<li><a class="reference internal" href="#amazing-gradients-and-where-to-find-them">Amazing gradients and where to find them</a></li>
<li><a class="reference internal" href="#what-if-the-values-have-components">What if the values have components?</a></li>
<li><a class="reference internal" href="#using-gradients-in-calculations">Using gradients in calculations</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/furo.js?v=4e2eecee"></script>
    <script src="../../_static/toggleprompt.js?v=5801b3bb"></script>
    <script src="../../_static/design-tabs.js?v=36754332"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../_static/js/custom.js?v=4b1677b9"></script>
    <script data-domain="docs.metatensor.org" defer="defer" src="https://plausible.io/js/script.js"></script>
    </body>
</html>